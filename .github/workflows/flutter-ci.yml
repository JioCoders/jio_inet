# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Flutter-CI

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*' # for tags like: 'v1.2.3'
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write # Required to push the new tag
  pull-requests: read

jobs:
  build:
    name: Flutter Build & Release
    # Only run the tagging logic on pushes to main, not on tag creation or PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for all tags and branches

      # Note: This workflow uses the latest stable version of the Dart SDK.
      # You can specify other versions if desired, see documentation here:
      # https://github.com/dart-lang/setup-dart/blob/main/README.md
      # - uses: dart-lang/setup-dart@v1

      # - uses: dart-lang/setup-dart@9a04e6d73cca37bd455e0608d7e5092f881fd603
      - name: Setup Flutter Environment
        uses: subosito/flutter-action@v2
        id: flutter-action
        with:
          channel: stable # [dev, beta]
          flutter-version: 3.24.4 #[5b12b74, tag, commit, branch, main]
          # flutter-version-file: pubspec.yaml # path to pubspec.yaml [exact-ver]
          # optional parameters follow
          cache: true

      - name: Print outputs - Command shell
        shell: bash
        run: |
          echo "Flutter Path: ${{ steps.flutter-action.outputs.flutter-path }}"
          echo "Pub Cache Path: ${{ steps.flutter-action.outputs.pub-cache-path }}"

      - name: Get Flutter Version
        run: |
          flutter --version
          flutter doctor

      - name: Install dependencies
        run: flutter pub get

      # Uncomment this step to verify the use of 'dart format' on each commit.
      # - name: Verify formatting
      #   run: dart format --output=none --set-exit-if-changed .

      # Consider passing '--fatal-infos' for slightly stricter analysis.
      - name: Analyze project source
        run: flutter analyze
      # run: flutter analyze --no-fatal-infos --no-fatal-warnings

      # Your project will need to have tests in test/ and a dependency on
      # package:test for this step to succeed. Note that Flutter projects will
      # want to change this to 'flutter test'.
      - name: Run tests
        run: flutter test

      - name: Format code
        run: dart format --fix .
      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .
      - name: Check Publish Warnings
        run: flutter pub publish --dry-run || true

      # Extract Version
      - name: Extract version from pubspec.yaml
        id: extract_version
        run: |
          version=$(grep '^version: ' pubspec.yaml | cut -d ' ' -f 2 | tr -d '\r')
          echo "VERSION=$version" >> $GITHUB_ENV

      # Check if Tag Exists
      - name: Check if Tag Exists
        id: check_tag
        run: |
          if git rev-parse "v${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "TAG_EXISTS=true" >> $GITHUB_ENV
          else
            echo "TAG_EXISTS=false" >> $GITHUB_ENV
          fi

      # Modify Tag if it Exist
      #      - name: Modify Tag
      #        if: env.TAG_EXISTS == 'true'
      #        id: modify_tag
      #        run: |
      #          new_version="${{ env.VERSION }}-build-${{ github.run_number }}"
      #          echo "VERSION=$new_version" >> $GITHUB_ENV

      - name: Get latest tag
        id: get_latest_tag
        run: |
          # Find the latest tag matching the 'v*' pattern, sorted by version
          LATEST_TAG=$(git tag --sort=-v:refname -l "v[0-9]*" | head -n 1)
          echo "Latest tag: $LATEST_TAG"
          echo "LATEST_TAG=${LATEST_TAG}" >> $GITHUB_ENV

      - name: Calculate Next Version Tag
        id: determine_tag
        run: |
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          
          VERSION=${LATEST_TAG#v}
          # Ensure we have 3 parts (major.minor.patch)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Fallback for PATCH if it's not a number
          if ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then PATCH=0; fi
          if ! [[ "$MINOR" =~ ^[0-9]+$ ]]; then MINOR=0; fi
          if ! [[ "$MAJOR" =~ ^[0-9]+$ ]]; then MAJOR=0; fi
          
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "Targeting Tag: $NEW_TAG"

      - name: Create and push new tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.PUB_DEV_CREDENTIALS }}

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.NEW_TAG }}  # Use the calculated tag (v0.0.2)
          name: Release ${{ env.NEW_TAG }}
          body: |
            Automated release for version ${{ env.NEW_TAG }}.
            Built from branch: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.PUB_DEV_CREDENTIALS }}

  publish:
    name: Publish to Pub.dev
    # if: startsWith(github.ref, 'refs/tags/v') # Only run if this is a tag push
    # Change: Run if the build job was successful on the main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build # Wait for the build job to create the tag
    permissions:
      id-token: write # Required for authentication using OIDC
    uses: dart-lang/setup-dart/.github/workflows/publish.yml@v1
    with:
      # Specify the github actions deployment environment
      environment: 'PUB_DEV_CREDENTIALS'
      # working-directory: path/to/package/within/repository
